<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melodic LoFi - Triads</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            background-color: #202028;
            color: #d0d0d8;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        #container {
            border: 1px solid #444;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            width: 320px;
            background: #2a2a35;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        h1 { color: #8be9fd; font-size: 1.2rem; margin-bottom: 5px; letter-spacing: 2px; }
        
        #readout {
            margin: 20px 0;
            text-align: left;
            font-size: 0.8rem;
            line-height: 1.8;
            color: #f8f8f2;
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            padding: 15px 0;
        }
        .label { color: #6272a4; margin-right: 10px; }
        .value { color: #f1fa8c; float: right;}

        /* MAIN BUTTON */
        #playBtn {
            background: #8be9fd;
            color: #202028;
            border: none;
            padding: 15px 0;
            width: 100%;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            font-size: 1.1em;
            transition: 0.2s;
            margin-bottom: 25px;
            border-radius: 4px;
        }
        #playBtn:hover { background: #b9f5ff; transform: translateY(-2px); }

        /* SLIDER */
        .vol-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #8be9fd;
        }
        input[type=range] {
            -webkit-appearance: none;
            width: 70%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #f1fa8c;
            cursor: pointer;
            margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #444;
            border-radius: 2px;
        }
        
        /* VISUALIZER */
        .vis-row { display: flex; justify-content: space-between; height: 10px; margin-top: 20px; gap: 2px;}
        .vis-bar { width: 100%; background: #444; transition: height 0.1s; height: 100%; border-radius: 2px;}
        .vis-active { background: #f1fa8c; box-shadow: 0 0 10px #f1fa8c;}
    </style>
</head>
<body>

    <div id="container">
        <h1>PURE TRIADS LOFI</h1>
        
        <div id="readout">
            <div><span class="label">BEAT:</span><span class="value">Locked / Steady</span></div>
            <div><span class="label">CHORD:</span><span id="ui-chord" class="value">--</span></div>
            <div><span class="label">MELODY:</span><span id="ui-note" class="value">--</span></div>
        </div>

        <button id="playBtn">START VIBE</button>

        <div class="vol-container">
            <span>MASTER VOL</span>
            <input type="range" id="volumeSlider" min="0" max="100" value="80">
        </div>

        <div class="vis-row">
            <div id="v1" class="vis-bar"></div>
            <div id="v2" class="vis-bar"></div>
            <div id="v3" class="vis-bar"></div>
            <div id="v4" class="vis-bar"></div>
        </div>
    </div>

    <script>
        // --- STATE ---
        let isPlaying = false;
        let measureCount = 0;
        
        // --- AUDIO NODES ---
        let chordSynth, melodySynth, bassSynth, kick, snare, hihat;
        let masterGain, sidechainMult, masterReverb, melodyDelay;

        // --- MUSICAL DATA (C MAJOR TRIADS ONLY) ---
        // Clean chords: Root, 3rd, 5th. No 7ths.
        const triads = [
            { name: "C Major", notes: ["C4", "E4", "G4"] },
            { name: "F Major", notes: ["F3", "A3", "C4"] },
            { name: "A Minor", notes: ["A3", "C4", "E4"] },
            { name: "G Major", notes: ["G3", "B3", "D4"] },
            { name: "E Minor", notes: ["E3", "G3", "B3"] },
            { name: "D Minor", notes: ["D3", "F3", "A3"] }
        ];

        // Pentatonic Scale for Melody (Safe notes only)
        const melodyScale = ["C5", "D5", "E5", "G5", "A5", "C6"];

        async function startSystem() {
            await Tone.start();
            Tone.Transport.bpm.value = 82; // Slightly faster, steadier head-nod

            // 1. MASTER CHAIN
            masterGain = new Tone.Gain(0.8).toDestination();
            
            // Sidechain Logic (Ducking)
            sidechainMult = new Tone.Multiply(1);
            
            // Reverb (Space)
            masterReverb = new Tone.Reverb({ decay: 2.5, wet: 0.3 }).connect(masterGain);
            sidechainMult.connect(masterReverb);

            // Melody Delay (Echo)
            melodyDelay = new Tone.FeedbackDelay("8n.", 0.4).connect(masterGain);


            // 2. INSTRUMENTS

            // CHORDS: Switched to gentle Triangle waves (Very clean, no harshness)
            chordSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "triangle" }, // Triangle = Smooth/Flute-like
                volume: -6,
                envelope: { attack: 0.05, decay: 0.1, sustain: 0.7, release: 1 }
            }).connect(sidechainMult);

            // MELODY: Soft Sine wave with glide (Portamento)
            melodySynth = new Tone.Synth({
                oscillator: { type: "sine" },
                portamento: 0.05, // Slides between notes
                volume: -12,
                envelope: { attack: 0.1, decay: 0.3, sustain: 0.4, release: 1.2 }
            }).connect(melodyDelay);

            // BASS: Deep Sine
            bassSynth = new Tone.MonoSynth({
                oscillator: { type: "sine" },
                volume: -4,
                envelope: { attack: 0.1, decay: 0.3, sustain: 0.9, release: 0.5 }
            }).connect(sidechainMult);

            // DRUMS: Locked pattern
            kick = new Tone.MembraneSynth({ volume: -2 }).connect(masterGain); // Kick bypasses reverb/sidechain for punch
            
            snare = new Tone.NoiseSynth({ 
                volume: -10,
                envelope: { attack: 0.001, decay: 0.2, sustain: 0 } 
            }).connect(masterReverb);

            hihat = new Tone.MetalSynth({ 
                volume: -20,
                envelope: { attack: 0.001, decay: 0.05, release: 0.01 },
                harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5
            }).connect(masterReverb);


            // 3. THE LOOP (100% Full Beat, No Breakdowns)
            Tone.Transport.scheduleRepeat((time) => {
                const step = measureCount % 16;
                visualize(step);

                // --- DRUMS (Steady Pattern) ---
                
                // Kick: 0, 10, and occasionally 7 (syncopated)
                if (step === 0 || step === 10) {
                    playKick(time);
                } else if (step === 7 && Math.random() > 0.5) {
                    playKick(time);
                }

                // Snare: Always 4 and 12
                if (step === 4 || step === 12) {
                    snare.triggerAttackRelease("16n", time);
                }

                // Hats: Every even beat + random ghosts
                if (step % 2 === 0) {
                    hihat.triggerAttackRelease("32n", time, 0.6);
                } else if (Math.random() > 0.7) {
                    hihat.triggerAttackRelease("32n", time, 0.2); // Soft ghost hat
                }


                // --- CHORDS (Change every bar) ---
                if (step === 0) {
                    // Pick a random triad
                    const chordObj = triads[Math.floor(Math.random() * triads.length)];
                    
                    // Update UI
                    Tone.Draw.schedule(() => {
                        document.getElementById('ui-chord').innerText = chordObj.name;
                    }, time);

                    // Play Chord
                    chordSynth.triggerAttackRelease(chordObj.notes, "1m", time);
                    
                    // Play Root Bass Note (Lower octave)
                    const bassNote = chordObj.notes[0].replace("4", "2").replace("3", "2");
                    bassSynth.triggerAttackRelease(bassNote, "1m", time);
                }

                // --- MELODY (Randomized Soft Noodling) ---
                // Only play on 8th notes (steps 0, 2, 4...) to keep it chill
                if (step % 2 === 0 && Math.random() > 0.4) {
                    // Pick a note from safe scale
                    const note = melodyScale[Math.floor(Math.random() * melodyScale.length)];
                    
                    // 20% chance to slide to a higher octave for variation
                    const finalNote = (Math.random() > 0.8) ? note.replace("5", "6") : note;

                    melodySynth.triggerAttackRelease(finalNote, "4n", time);
                    
                    Tone.Draw.schedule(() => {
                        document.getElementById('ui-note').innerText = finalNote;
                    }, time);
                }

                measureCount++;
            }, "16n");

            Tone.Transport.start();
        }

        function playKick(time) {
            kick.triggerAttackRelease("C1", "8n", time);
            // Sidechain Ducking (Brief volume drop)
            sidechainMult.setValueAtTime(0.2, time);
            sidechainMult.linearRampToValueAtTime(1, time + 0.15);
        }

        function visualize(step) {
            const bars = document.querySelectorAll('.vis-bar');
            const index = Math.floor(step / 4);
            bars.forEach(b => b.classList.remove('vis-active'));
            if(bars[index]) bars[index].classList.add('vis-active');
        }

        // --- CONTROLS ---
        const btn = document.getElementById('playBtn');
        const volSlider = document.getElementById('volumeSlider');

        volSlider.addEventListener('input', (e) => {
            if(masterGain) {
                masterGain.gain.rampTo(e.target.value / 100, 0.1);
            }
        });

        btn.addEventListener('click', async () => {
            if(!isPlaying) {
                await startSystem();
                isPlaying = true;
                btn.innerText = "STOP MUSIC";
                btn.style.background = "#ff5555";
                btn.style.color = "#fff";
            } else {
                Tone.Transport.stop();
                Tone.Destination.mute = true;
                location.reload();
            }
        });

    </script>
</body>
</html>
