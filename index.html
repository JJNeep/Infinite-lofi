<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolving LoFi Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            background-color: #0f0f0f;
            color: #a0a0a0;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            transition: background-color 10s ease;
        }
        #container {
            border: 1px solid #333;
            padding: 50px;
            border-radius: 4px;
            text-align: center;
            width: 300px;
        }
        h1 { color: #50fa7b; font-size: 1.2rem; margin-bottom: 5px; letter-spacing: 2px; }
        
        #readout {
            margin: 30px 0;
            text-align: left;
            font-size: 0.85rem;
            line-height: 1.6;
            color: #f8f8f2;
        }
        .label { color: #6272a4; margin-right: 10px; }
        .value { color: #ff79c6; }

        button {
            background: transparent;
            color: #50fa7b;
            border: 1px solid #50fa7b;
            padding: 10px 30px;
            cursor: pointer;
            font-family: inherit;
            transition: 0.3s;
        }
        button:hover { background: #50fa7b; color: #0f0f0f; }
        
        /* Loading animation */
        #loader { height: 2px; width: 0%; background: #bd93f9; transition: width 0.2s; margin-top:20px;}
    </style>
</head>
<body>

    <div id="container">
        <h1>EVOLVING LOFI</h1>
        
        <div id="readout">
            <div><span class="label">PHASE:</span><span id="ui-phase" class="value">Stopped</span></div>
            <div><span class="label">FILTER:</span><span id="ui-filter" class="value">--</span></div>
            <div><span class="label">KEY:</span><span id="ui-key" class="value">--</span></div>
            <div><span class="label">DRIFT:</span><span id="ui-drift" class="value">--</span></div>
        </div>

        <button id="playBtn">INITIATE</button>
        <div id="loader"></div>
    </div>

    <script>
        // --- STATE VARIABLES ---
        let isPlaying = false;
        let measureCount = 0;
        
        // --- AUDIO NODES ---
        let keys, kick, snare, hihat, bass;
        let masterGain, sidechainMult, masterFilter, reverb;

        // --- PROGRESSIONS ---
        // We will swap between these two moods
        const progressionA = [ // "The Nostalgia"
            ["F3", "A3", "C4", "E4"], // F Maj7
            ["E3", "G3", "B3", "D4"], // E min7
            ["D3", "F3", "A3", "C4"], // D min7
            ["G2", "F3", "A3", "B3"]  // G Dom7
        ];
        const progressionB = [ // "The Dream"
            ["Db3", "F3", "Ab3", "C4"], // Db Maj7
            ["C3", "Eb3", "G3", "Bb3"], // C min7
            ["Bb2", "D3", "F3", "A3"],  // Bb Maj7
            ["Eb3", "G3", "Bb3", "D4"]  // Eb Maj7
        ];
        
        let currentProgression = progressionA;

        async function startSystem() {
            await Tone.start();
            Tone.Transport.bpm.value = 78;

            // 1. SIGNAL CHAIN
            // Everything goes into a LowPass filter that we will automate slowly
            masterFilter = new Tone.Filter(600, "lowpass"); 
            reverb = new Tone.Reverb({ decay: 4, wet: 0.4 }).toDestination();
            sidechainMult = new Tone.Multiply(1); // Used for ducking volume
            
            // Connect: Source -> SidechainMult -> Filter -> Reverb -> Out
            sidechainMult.connect(masterFilter);
            masterFilter.connect(reverb);

            // 2. INSTRUMENTS

            // Polymorphic Keys (Changes tone over time)
            keys = new Tone.PolySynth(Tone.FMSynth, {
                harmonicity: 1,
                modulationIndex: 1,
                envelope: { attack: 0.2, decay: 0.5, sustain: 0.5, release: 2 }
            }).connect(sidechainMult);
            keys.volume.value = -8;

            // Simple Bass (Sine wave)
            bass = new Tone.MonoSynth({
                oscillator: { type: "triangle" },
                envelope: { attack: 0.1, decay: 0.3, sustain: 0.8, release: 1 },
                filterEnvelope: { attack: 0.001, decay: 0.1, sustain: 0.5, baseFrequency: 100, octaves: 2 }
            }).connect(sidechainMult);
            bass.volume.value = -6;

            // Drums (Kick bypasses filter so it stays thumping, Snare/Hat go through filter)
            kick = new Tone.MembraneSynth().toDestination(); // Kick is raw
            kick.volume.value = -2;

            snare = new Tone.NoiseSynth({
                envelope: { attack: 0.001, decay: 0.2, sustain: 0 }
            }).connect(masterFilter); // Snare gets filtered
            snare.volume.value = -12;

            hihat = new Tone.MetalSynth({
                harmonicity: 5.1,
                modulationIndex: 32,
                resonance: 4000,
                octaves: 1.5,
                envelope: { attack: 0.001, decay: 0.1, release: 0.01 }
            }).connect(masterFilter);
            hihat.volume.value = -22;


            // 3. THE CONDUCTOR (Loop)
            // Loops every 16th note
            Tone.Transport.scheduleRepeat((time) => {
                const step = measureCount % 16;
                const totalMeasures = Math.floor(measureCount / 16);
                
                // --- A. EVOLUTION LOGIC (The "Slow Change") ---
                // Every 32 steps (2 bars), check if we need to evolve parameters
                if (step === 0 && measureCount % 32 === 0) {
                    evolveSound(time);
                }

                // --- B. ARRANGEMENT LOGIC (Building Layers) ---
                // We define intensity based on total bars played
                // Cycle: Intro (0-8) -> Build (8-16) -> Full (16-32) -> Breakdown (32-40)
                const arrangementCycle = Math.floor(measureCount / 64) % 4; // 0, 1, 2, or 3
                updateUI(arrangementCycle);

                let playKick = false;
                let playSnare = false;
                let playHats = false;

                if (arrangementCycle === 0) { // Phase 1: Just Chords + Sparse Hats
                    playHats = true; 
                } else if (arrangementCycle === 1) { // Phase 2: Add Kick (No snare)
                    playKick = true;
                    playHats = true;
                } else if (arrangementCycle === 2) { // Phase 3: Full Beat
                    playKick = true;
                    playSnare = true;
                    playHats = true;
                } else { // Phase 4: Breakdown (Just Chords, filtered down)
                     // Silence drums
                }

                // --- C. PLAYBACK ---
                
                // KICK (Beat 0 & 10)
                if (playKick && (step === 0 || step === 10)) {
                    kick.triggerAttackRelease("C1", "8n", time);
                    // Sidechain Ducking
                    sidechainMult.setValueAtTime(0.1, time);
                    sidechainMult.linearRampToValueAtTime(1, time + 0.2);
                }

                // SNARE (Beat 4 & 12)
                if (playSnare && (step === 4 || step === 12)) {
                    snare.triggerAttackRelease("16n", time);
                }

                // HATS (Beat 0, 2, 4...)
                if (playHats && step % 2 === 0) {
                    // Randomize velocity for human feel
                    hihat.triggerAttackRelease("32n", time, Math.random()*0.5 + 0.3);
                }

                // CHORDS (Change every 16 steps / 1 bar)
                if (step === 0) {
                    // Pick chord from current progression
                    const chordIdx = Math.floor(measureCount / 16) % 4;
                    const chord = currentProgression[chordIdx];
                    
                    // Play Keys
                    chord.forEach((n, i) => {
                        keys.triggerAttackRelease(n, "2m", time + i*0.03);
                    });

                    // Play Bass (Root note of chord)
                    // We parse the root note (e.g., "F3" -> "F1")
                    let root = chord[0].replace("3", "1").replace("2", "1");
                    if(playKick) bass.triggerAttackRelease(root, "1m", time);
                }

                measureCount++;
            }, "16n");

            Tone.Transport.start();
        }

        // 4. THE EVOLUTION ENGINE
        function evolveSound(time) {
            // 1. Slow Filter Sweep (Muffled <-> Bright)
            // Uses a Sine wave logic based on time
            const now = Tone.now();
            const sweep = Math.sin(now * 0.05); // Slow oscillation
            // Map -1/1 to Frequency 200Hz - 3000Hz
            const newFreq = 1600 + (sweep * 1400); 
            masterFilter.frequency.rampTo(newFreq, 4); // Ramp over 4 seconds

            // 2. Synth Tone Morphing
            // Change how "metallic" the keys sound
            const harmonicity = 1 + (Math.sin(now * 0.1) * 0.5); 
            keys.set({ harmonicity: harmonicity });

            // 3. Chord Progression Swap
            // Every ~45 seconds, swap the emotion
            if (Math.random() > 0.8) {
                currentProgression = (currentProgression === progressionA) ? progressionB : progressionA;
            }
        }

        // 5. UI UPDATES
        function updateUI(phase) {
            const phaseNames = ["Intro / Drift", "Building Up", "Full Groove", "Breakdown"];
            document.getElementById('ui-phase').innerText = phaseNames[phase];
            
            // Visualizer bar
            const beat = measureCount % 16;
            document.getElementById('loader').style.width = (beat/16)*100 + "%";

            // Update text readouts
            document.getElementById('ui-filter').innerText = Math.floor(masterFilter.frequency.value) + "Hz";
            document.getElementById('ui-key').innerText = (currentProgression === progressionA) ? "Natural Minor" : "Deep Jazz";
            document.getElementById('ui-drift').innerText = Math.floor(keys.get().harmonicity * 100) + "% FM";
        }

        // --- BUTTON HANDLER ---
        const btn = document.getElementById('playBtn');
        btn.addEventListener('click', async () => {
            if(!isPlaying) {
                await startSystem();
                isPlaying = true;
                btn.innerText = "TERMINATE";
                btn.style.color = "#ff5555";
                btn.style.borderColor = "#ff5555";
            } else {
                Tone.Transport.stop();
                Tone.Destination.mute = true;
                location.reload();
            }
        });

    </script>
</body>
</html>
